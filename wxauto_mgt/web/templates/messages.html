{% extends "base.html" %}

{% block head %}
<style>
    .messages-container {
        display: flex;
        flex-direction: column;
        height: 100vh; /* 使用全视口高度，因为container-fluid已经减去了导航栏高度 */
        padding: 0;
    }
    .split-view {
        display: flex;
        flex: 1;
        overflow: hidden;
        gap: 20px;
        padding: 20px;
        height: 100%; /* 使用100%高度 */
        box-sizing: border-box;
    }
    .listeners-panel {
        width: 300px;
        background-color: #f8f9fa;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
    }
    .listeners-header {
        padding: 20px 15px 15px 15px;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }
    .listeners-title-section {
        flex: 1;
    }
    .listeners-main-title {
        font-size: 1.5rem;
        font-weight: bold;
        margin: 0 0 5px 0;
        color: #333;
    }
    .listeners-subtitle {
        font-size: 0.9rem;
        color: #6c757d;
        margin: 0;
    }
    .listeners-subheader {
        padding: 10px 15px;
        border-bottom: 1px solid #dee2e6;
        background-color: #fff;
    }
    .listeners-list-title {
        font-size: 1.1rem;
        font-weight: bold;
        margin: 0;
        color: #495057;
    }
    .listeners-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
    }
    .listener-item {
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 5px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .listener-item:hover {
        background-color: #e9ecef;
    }
    .listener-item.active {
        background-color: #007bff;
        color: white;
    }
    .listener-actions {
        padding: 15px;
        border-top: 1px solid #dee2e6;
    }
    .messages-panel {
        flex: 1;
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        height: 100%; /* 使用100%高度 */
        box-sizing: border-box;
    }
    .messages-header {
        padding: 15px;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #f8f9fa;
        border-radius: 10px 10px 0 0;
    }
    .messages-title {
        font-size: 1.1rem;
        font-weight: bold;
        margin: 0;
        color: #495057;
    }
    .messages-list {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 15px;
        height: 100%; /* 使用100%高度而不是min/max-height */
        box-sizing: border-box;
    }
    /* 移除旧的消息样式，使用新的气泡样式 */
    /* 日志抽屉遮罩层 */
    .logs-drawer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
        z-index: 999;
    }
    .logs-drawer-overlay.show {
        opacity: 1;
        visibility: visible;
    }

    /* 日志抽屉样式 */
    .logs-drawer {
        position: fixed;
        top: 0;
        right: -75vw; /* 初始隐藏在右侧，宽度为视口的75% */
        width: 75vw; /* 占屏幕的3/4 */
        height: 100vh;
        background-color: #fff;
        box-shadow: -4px 0 15px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        transition: right 0.3s ease;
        z-index: 1000;
        border-left: 1px solid #dee2e6;
    }
    .logs-drawer.open {
        right: 0; /* 显示时滑入 */
    }
    .logs-drawer-header {
        padding: 15px;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #f8f9fa;
        flex-shrink: 0;
    }
    .logs-drawer-title {
        font-size: 1.1rem;
        font-weight: bold;
        margin: 0;
        color: #495057;
    }
    .logs-drawer-controls {
        display: flex;
        align-items: center;
    }
    .logs-drawer-content {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        font-family: monospace;
        font-size: 0.9rem;
        background-color: #f8f9fa;
    }

    /* 日志过滤栏样式 */
    .logs-filter-bar {
        padding: 10px 15px;
        border-bottom: 1px solid #dee2e6;
        background-color: #fff;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }

    .log-level-filters {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .filter-label {
        font-size: 0.9rem;
        color: #6c757d;
        font-weight: 500;
    }

    .form-check-label {
        font-size: 0.9rem;
        color: #495057;
    }

    /* 消息控制按钮样式 */
    .messages-controls {
        display: flex;
        align-items: center;
    }
    /* 日志项样式 */
    .log-item {
        margin-bottom: 5px;
        white-space: pre-wrap;
        word-break: break-all;
        padding: 2px 0;
        transition: opacity 0.2s ease;
    }

    .log-item.hidden {
        display: none;
    }

    .log-debug {
        color: #6c757d;
        opacity: 0.8;
    }

    .log-info {
        color: #0d6efd;
    }

    .log-warning {
        color: #ffc107;
        background-color: rgba(255, 193, 7, 0.1);
        padding: 2px 4px;
        border-radius: 3px;
    }

    .log-error {
        color: #dc3545;
        background-color: rgba(220, 53, 69, 0.1);
        padding: 2px 4px;
        border-radius: 3px;
        font-weight: 500;
    }
    .refresh-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
    }
    .empty-state {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
        color: #6c757d;
    }
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 15px;
    }
</style>
{% endblock %}

{% block content %}
<style>
    /* 覆盖base.html中的container-fluid样式 */
    .container-fluid.mt-3 {
        margin-top: 0 !important;
        padding: 0 !important;
        height: calc(100vh - 56px) !important; /* 减去导航栏高度 */
    }

    /* 隐藏footer */
    .footer {
        display: none !important;
    }

    /* 强制移除所有可能的底部空白 */
    body {
        margin: 0 !important;
        padding: 0 !important;
    }

    /* 确保没有额外的空白元素 */
    .messages-container::after,
    .split-view::after,
    .messages-panel::after,
    .messages-list::after {
        display: none !important;
    }

    /* 确保没有额外的margin和padding */
    .messages-container,
    .split-view,
    .messages-panel,
    .messages-list {
        margin: 0 !important;
    }
</style>

<div class="messages-container">
        <!-- 分栏视图：左侧监听对象列表，中间消息记录，右侧日志抽屉 -->
        <div class="split-view">
            <!-- 监听对象列表 -->
            <div class="listeners-panel">
                <div class="listeners-header">
                    <div class="listeners-title-section">
                        <h2 class="listeners-main-title">消息监控</h2>
                        <p class="listeners-subtitle">监控微信消息和系统日志</p>
                    </div>
                    <button id="refresh-listeners" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="listeners-subheader">
                    <h5 class="listeners-list-title">监听对象列表</h5>
                </div>
                <div class="listeners-list" id="listeners-list">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <p class="mt-2">加载监听对象列表...</p>
                    </div>
                </div>
                <div class="listener-actions">
                    <button id="add-listener" class="btn btn-sm btn-primary w-100 mb-2">
                        <i class="fas fa-plus"></i> 添加监听对象
                    </button>
                    <button id="fixed-listeners" class="btn btn-sm btn-success w-100 mb-2">
                        <i class="fas fa-thumbtack"></i> 固定监听
                    </button>
                    <button id="delete-listener" class="btn btn-sm btn-outline-danger w-100" disabled>
                        <i class="fas fa-trash-alt"></i> 删除监听对象
                    </button>
                </div>
            </div>

            <!-- 消息记录 -->
            <div class="messages-panel">
                <div class="messages-header">
                    <h5 class="messages-title">消息记录</h5>
                    <div class="messages-controls">
                        <button id="refresh-messages" class="btn btn-sm btn-outline-primary me-2">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button id="toggle-logs-drawer" class="btn btn-sm btn-info">
                            <i class="fas fa-list-alt"></i>
                            <span class="toggle-text">日志</span>
                        </button>
                    </div>
                </div>
                <div class="messages-list" id="messages-list">
                    <div class="empty-state">
                        <i class="fas fa-comments"></i>
                        <p>请选择一个监听对象查看消息</p>
                    </div>
                </div>
            </div>

            <!-- 日志抽屉遮罩层 -->
            <div class="logs-drawer-overlay" id="logs-drawer-overlay"></div>

            <!-- 消息监听日志抽屉 - 从右侧滑出 -->
            <div class="logs-drawer" id="logs-drawer">
                <div class="logs-drawer-header">
                    <h5 class="logs-drawer-title">消息监听日志</h5>
                    <div class="logs-drawer-controls">
                        <button id="refresh-logs" class="btn btn-sm btn-outline-primary me-2">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button id="close-logs-drawer" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="logs-filter-bar">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="hide-debug-logs" checked>
                        <label class="form-check-label" for="hide-debug-logs">
                            屏蔽DEBUG日志
                        </label>
                    </div>
                    <div class="log-level-filters">
                        <span class="filter-label">显示级别:</span>
                        <div class="btn-group btn-group-sm" role="group">
                            <input type="checkbox" class="btn-check" id="show-info" checked>
                            <label class="btn btn-outline-info" for="show-info">INFO</label>

                            <input type="checkbox" class="btn-check" id="show-warning" checked>
                            <label class="btn btn-outline-warning" for="show-warning">WARN</label>

                            <input type="checkbox" class="btn-check" id="show-error" checked>
                            <label class="btn btn-outline-danger" for="show-error">ERROR</label>
                        </div>
                    </div>
                </div>
                <div class="logs-drawer-content" id="logs-list">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <p class="mt-2">加载日志...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加监听对象模态框 -->
<div class="modal fade" id="listenerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加监听对象</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="listenerForm">
                    <div class="mb-3">
                        <label for="listener-instance" class="form-label">实例</label>
                        <select class="form-select" id="listener-instance" required>
                            <option value="">请选择实例</option>
                            <!-- 实例选项将动态加载 -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="listener-chat" class="form-label">聊天对象</label>
                        <input type="text" class="form-control" id="listener-chat" required>
                        <div class="form-text">输入聊天对象的名称，例如：群聊名称、好友昵称等</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="save-listener">添加</button>
            </div>
        </div>
    </div>
</div>

<!-- 固定监听配置模态框 -->
<div class="modal fade" id="fixedListenersModal" tabindex="-1" aria-labelledby="fixedListenersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fixedListenersModalLabel">固定监听配置</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- 左侧：固定监听列表 -->
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">固定监听列表</h6>
                            <button type="button" class="btn btn-sm btn-primary" id="add-fixed-listener">
                                <i class="fas fa-plus"></i> 添加
                            </button>
                        </div>
                        <div class="list-group" id="fixed-listeners-list" style="max-height: 300px; overflow-y: auto;">
                            <div class="text-center py-3">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                                <p class="mt-2 mb-0 text-muted">加载固定监听配置...</p>
                            </div>
                        </div>
                    </div>

                    <!-- 右侧：详情编辑 -->
                    <div class="col-md-6">
                        <h6 class="mb-3">详情编辑</h6>
                        <form id="fixed-listener-form">
                            <div class="mb-3">
                                <label for="fixed-session-name" class="form-label">会话名称 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="fixed-session-name" placeholder="请输入会话名称" required>
                                <div class="invalid-feedback">
                                    会话名称不能为空
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="fixed-enabled" checked>
                                    <label class="form-check-label" for="fixed-enabled">
                                        启用此固定监听
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="fixed-description" class="form-label">描述</label>
                                <textarea class="form-control" id="fixed-description" rows="3" placeholder="可选：输入描述信息"></textarea>
                            </div>
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-success" id="save-fixed-listener" disabled>
                                    <i class="fas fa-save"></i> 保存更改
                                </button>
                                <button type="button" class="btn btn-outline-danger" id="delete-fixed-listener" disabled>
                                    <i class="fas fa-trash-alt"></i> 删除配置
                                </button>
                            </div>
                        </form>

                        <!-- 说明信息 -->
                        <div class="alert alert-info mt-3" role="alert">
                            <small>
                                <i class="fas fa-info-circle"></i>
                                固定监听的会话将在服务启动时自动添加到所有实例的监听列表中，且不受超时机制影响。
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', path='/js/pages/messages.js') }}"></script>
{% endblock %}
