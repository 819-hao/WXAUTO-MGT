# 扣子(Coze)服务平台使用指南

## 概述

扣子(Coze)服务平台插件为WXAUTO-MGT系统提供了与扣子AI平台的完整集成，支持智能对话、工作空间管理、智能体选择和连续对话等功能。

## 功能特性

- ✅ **工作空间管理**: 动态获取和选择用户的工作空间
- ✅ **智能体选择**: 基于工作空间动态加载可用的智能体(Bot)
- ✅ **异步对话处理**: 支持扣子API的异步对话模式，自动轮询对话状态
- ✅ **连续对话**: 可选的会话上下文保持功能
- ✅ **动态表单UI**: 基于现有架构的配置界面
- ✅ **错误处理**: 完善的错误处理和日志记录
- ✅ **连接测试**: 内置的API连接验证功能

## 配置要求

### 1. API密钥获取

1. 访问 [扣子开放平台](https://www.coze.cn/open)
2. 登录您的账户
3. 创建应用并获取API密钥（格式通常为 `pat_...`）

### 2. 工作空间和智能体

- 确保您的账户下有可用的工作空间
- 在工作空间中创建或发布智能体
- 智能体需要处于"已发布"状态才能被API调用

## 配置步骤

### 方法一：通过UI界面配置

1. **打开平台管理界面**
   - 启动WXAUTO-MGT应用
   - 进入"实例管理"选项卡
   - 点击"服务平台"按钮

2. **添加Coze平台**
   - 点击"添加平台"按钮
   - 输入平台名称（如："我的Coze助手"）
   - 选择平台类型："扣子(Coze)"

3. **配置API密钥**
   - 在"API密钥"字段输入您的扣子API密钥
   - 点击"刷新工作空间"按钮

4. **选择工作空间**
   - 从下拉列表中选择要使用的工作空间
   - 点击"刷新智能体"按钮

5. **选择智能体**
   - 从下拉列表中选择要使用的智能体
   - 可选：启用"连续对话"功能

6. **保存配置**
   - 点击"测试连接"验证配置
   - 点击"确定"保存平台配置

### 方法二：通过Web界面配置

1. 访问Web管理界面（通常是 `http://localhost:5000`）
2. 进入"服务平台"页面
3. 按照类似的步骤进行配置

## 配置参数说明

| 参数名称 | 是否必填 | 说明 |
|---------|---------|------|
| API密钥 | ✅ | 扣子平台的API访问密钥 |
| 工作空间 | ✅ | 选择要使用的工作空间 |
| 智能体 | ✅ | 选择要调用的智能体 |
| 连续对话 | ❌ | 是否保持会话上下文（默认：关闭）|
| 消息发送模式 | ❌ | 普通模式或打字机模式（默认：普通）|

## API端点说明

Coze平台插件使用以下API端点：

- **工作空间列表**: `GET https://api.coze.cn/v1/workspaces`
- **智能体列表**: `GET https://api.coze.cn/v1/bots?workspace_id={workspace_id}`
- **创建对话**: `POST https://api.coze.cn/v3/chat`
- **检查对话状态**: `GET https://api.coze.cn/v3/chat/retrieve`
- **获取对话消息**: `GET https://api.coze.cn/v3/chat/message/list`

## 使用流程

### 1. 消息处理流程

```
微信消息 → 消息监听服务 → 消息投递服务 → Coze平台插件
    ↓
创建对话 → 轮询状态 → 获取回复 → 发送到微信
```

### 2. 对话状态轮询

- 最多轮询60次，每次间隔2秒
- 支持的状态：`created`、`in_progress`、`completed`、`failed`
- 自动处理超时和错误情况

### 3. 连续对话机制

当启用连续对话时：
- 系统会为每个用户维护独立的会话ID
- 后续消息会使用相同的会话ID，保持上下文
- 会话ID存储在内存中，重启后会重置

## 测试验证

### 1. 使用测试脚本

```bash
# 设置API密钥环境变量
export COZE_API_KEY="your_api_key_here"

# 运行测试脚本
python test_coze_platform.py
```

### 2. 通过UI测试

1. 在平台配置界面点击"测试连接"
2. 检查是否能成功获取工作空间和智能体列表
3. 创建消息投递规则，指向Coze平台
4. 发送测试消息验证完整流程

## 故障排除

### 常见问题

1. **API密钥无效**
   - 检查密钥格式是否正确（应以`pat_`开头）
   - 确认密钥未过期且有足够权限

2. **无法获取工作空间**
   - 检查网络连接
   - 确认账户下有可用的工作空间

3. **无法获取智能体**
   - 确认选择的工作空间下有已发布的智能体
   - 检查智能体状态是否为"已发布"

4. **消息处理超时**
   - 检查智能体响应时间
   - 确认智能体配置正确且能正常工作

### 日志查看

Coze平台插件使用专用的日志记录器：
- 主日志：`wxauto_mgt` logger
- 调试日志：`coze_debug` logger

可以通过调整日志级别来获取更详细的调试信息。

## 性能优化建议

1. **合理设置轮询间隔**: 默认2秒间隔适合大多数场景
2. **选择性启用连续对话**: 仅在需要上下文的场景下启用
3. **监控API调用频率**: 避免超出扣子平台的API限制
4. **定期清理会话缓存**: 长时间运行时考虑清理内存中的会话数据

## 更新日志

- **v1.0.1** (2024-07-02): 修复版本
  - 修正了API端点地址
  - 修复了UI异步任务冲突问题
  - 优化了工作空间和智能体加载机制
  - 改进了错误处理和用户体验

- **v1.0.0** (2024-07-02): 初始版本发布
  - 支持基本的对话功能
  - 动态工作空间和智能体选择
  - 连续对话支持
  - 完整的UI集成

## 技术支持

如遇到问题，请：
1. 查看日志文件获取详细错误信息
2. 运行测试脚本验证基本功能
3. 检查扣子平台的API文档和状态页面
