# 消息规则优先级与冲突处理

本文档详细说明消息转发规则的优先级设计和冲突处理机制，确保系统在多规则环境下的行为可预测且符合用户预期。

## 1. 规则优先级设计

### 1.1 优先级概念

在消息转发系统中，一个实例可以关联多个规则，这些规则可能在某些情况下存在重叠。优先级机制确保系统能够以一致且可预测的方式决定应用哪条规则。

**优先级定义**：
- 优先级是一个整数值，数值越大表示优先级越高
- 默认优先级为0
- 推荐的优先级范围：0-100，便于用户理解和管理

### 1.2 优先级设计原则

1. **明确性**：优先级数值应当明确表示规则的重要程度
2. **可预测性**：相同条件下，系统应始终选择相同的规则
3. **可管理性**：优先级体系应易于用户理解和管理
4. **灵活性**：允许用户根据需要调整规则的优先级

### 1.3 优先级分配建议

| 优先级范围 | 适用场景 |
|----------|---------|
| 80-100   | 关键规则，必须优先应用 |
| 50-79    | 重要规则，通常应该应用 |
| 20-49    | 普通规则，在没有更高优先级规则时应用 |
| 0-19     | 默认规则，作为兜底方案 |

## 2. 规则匹配与应用顺序

### 2.1 规则匹配逻辑

当系统需要为一条消息确定应用哪条规则时，将按照以下逻辑进行匹配：

1. **筛选阶段**：首先筛选出所有可能适用的规则
   - 实例ID匹配：规则的实例ID等于消息的实例ID，或规则适用于所有实例（实例ID为"*"）
   - 聊天对象匹配：规则的聊天对象模式匹配消息的聊天对象名称

2. **排序阶段**：对筛选出的规则按照以下顺序进行排序
   - 首先按优先级降序排序（优先级高的规则排在前面）
   - 优先级相同时，按匹配精确度排序（精确匹配 > 正则表达式匹配 > 通配符匹配）
   - 如果以上条件都相同，则按规则ID排序，确保行为一致性

3. **选择阶段**：选择排序后的第一条规则应用

### 2.2 匹配精确度排序

匹配精确度的排序逻辑如下：

1. **精确匹配**：规则的聊天对象模式与消息的聊天对象名称完全一致
   - 例如：规则模式 = "技术支持群"，消息聊天对象 = "技术支持群"

2. **正则表达式匹配**：规则使用正则表达式匹配聊天对象
   - 例如：规则模式 = "regex:^VIP.*群$"，匹配所有以"VIP"开头、以"群"结尾的聊天对象

3. **通配符匹配**：规则使用通配符（*）匹配所有聊天对象
   - 例如：规则模式 = "*"，匹配任何聊天对象

## 3. 规则冲突处理

### 3.1 冲突类型

在多规则环境下，可能出现以下几种冲突情况：

1. **完全重叠**：两条规则适用于完全相同的实例和聊天对象
   - 例如：规则A和规则B都适用于"微信实例1"的"技术支持群"

2. **部分重叠**：两条规则在某些情况下会同时适用
   - 例如：规则A适用于"微信实例1"的所有聊天对象，规则B适用于"微信实例1"的"技术支持群"

3. **通配符冲突**：通配符规则与特定规则冲突
   - 例如：规则A适用于所有实例的所有聊天对象，规则B适用于"微信实例1"的"技术支持群"

### 3.2 冲突解决策略

系统采用以下策略解决规则冲突：

1. **优先级优先**：始终应用优先级最高的规则
   - 这是解决冲突的主要机制
   - 用户可以通过调整优先级来控制规则的应用顺序

2. **精确度考量**：在优先级相同的情况下，考虑匹配精确度
   - 精确匹配优先于正则表达式匹配
   - 正则表达式匹配优先于通配符匹配

3. **规则ID作为最终决定因素**：如果以上条件都相同，使用规则ID确保一致性
   - 这种情况在实际应用中应该很少发生

### 3.3 冲突检测与提示

系统应主动检测并提示用户可能的规则冲突：

1. **创建/编辑规则时**：检查新规则是否与现有规则冲突
   - 如果发现冲突，显示警告信息
   - 提供调整优先级的建议

2. **规则列表中**：视觉标识可能冲突的规则
   - 使用颜色或图标标记存在潜在冲突的规则
   - 提供"检查冲突"功能，帮助用户识别和解决冲突

## 4. UI设计与实现

### 4.1 优先级设置UI

在规则创建/编辑对话框中，优先级设置应该直观且易于使用：

```
+-------------------------------------------+
|  添加消息转发规则                           |
+-------------------------------------------+
|  ...其他字段...                            |
|                                           |
|  优先级:  [  50    ] ▲ ▼                  |
|  +---------------------------------------+|
|  |  0         低优先级            高优先级  ||
|  |  ●---------------------------------○  ||
|  |           |                           ||
|  |          50                          100|
|  +---------------------------------------+|
|  提示: 数字越大优先级越高。推荐值:            |
|  默认规则: 0-19, 普通规则: 20-49,           |
|  重要规则: 50-79, 关键规则: 80-100          |
|                                           |
|  [取消]                          [确定]     |
+-------------------------------------------+
```

### 4.2 规则列表中的优先级显示

规则列表应清晰显示优先级，并按优先级排序：

```
+-------------------------------------------------------+
| ID | 名称     | 实例    | 聊天匹配  | 平台  | 优先级 | 操作  |
|----+----------+---------+----------+------+-------+------|
| 2  | VIP规则   | 微信实例1| VIP客户群 | GPT-4|  80 ⭐ |[编辑] |
|    |          | 📱      |          |      |       |[删除] |
|----+----------+---------+----------+------+-------+------|
| 3  | 技术支持  | 微信实例1| 技术支持群| Dify |  50   |[编辑] |
|    |          | 📱      |          |      |       |[删除] |
|----+----------+---------+----------+------+-------+------|
| 1  | 默认规则  | 全部    |    *     | Dify |   0   |[编辑] |
|    |          | 🌐      |          |      |       |[删除] |
+-------------------------------------------------------+
```

- ⭐ 表示高优先级规则（80-100）
- 表格默认按优先级降序排序

### 4.3 冲突提示UI

当检测到规则冲突时，系统应提供清晰的视觉提示：

```
+-------------------------------------------+
|  ⚠️ 规则冲突警告                           |
+-------------------------------------------+
|  您正在创建的规则与以下现有规则存在冲突:     |
|                                           |
|  • "VIP规则" (优先级: 80)                  |
|    适用于: 微信实例1 / VIP客户群            |
|                                           |
|  您的新规则:                               |
|  • "测试规则" (优先级: 50)                  |
|    适用于: 微信实例1 / VIP客户群            |
|                                           |
|  由于新规则优先级较低，它可能不会被应用。     |
|                                           |
|  建议:                                     |
|  • 提高新规则的优先级 (>80)                 |
|  • 修改规则的适用范围以避免冲突              |
|  • 保持现状，接受基于优先级的规则应用         |
|                                           |
|  [取消]  [保持现状]  [提高优先级]  [修改范围] |
+-------------------------------------------+
```

### 4.4 规则匹配逻辑代码实现

```python
async def match_rule_for_message(instance_id: str, chat_name: str) -> Optional[Dict]:
    """
    为消息匹配适用的规则

    Args:
        instance_id: 实例ID
        chat_name: 聊天对象名称

    Returns:
        Optional[Dict]: 匹配的规则，如果没有匹配则返回None
    """
    # 获取所有启用的规则
    rules = await db_manager.fetchall(
        """
        SELECT * FROM delivery_rules
        WHERE enabled = 1
        AND (instance_id = ? OR instance_id = '*')
        ORDER BY priority DESC
        """,
        (instance_id,)
    )

    # 按匹配精确度分类规则
    exact_matches = []
    regex_matches = []
    wildcard_matches = []

    for rule in rules:
        pattern = rule['chat_pattern']

        # 精确匹配
        if pattern == chat_name:
            exact_matches.append(rule)
        # 通配符匹配
        elif pattern == '*':
            wildcard_matches.append(rule)
        # 正则表达式匹配
        elif pattern.startswith('regex:'):
            regex = pattern[6:]
            try:
                if re.match(regex, chat_name):
                    regex_matches.append(rule)
            except Exception as e:
                logger.error(f"正则表达式匹配失败: {e}")

    # 按优先级排序各类匹配
    exact_matches.sort(key=lambda x: (-x['priority'], x['rule_id']))
    regex_matches.sort(key=lambda x: (-x['priority'], x['rule_id']))
    wildcard_matches.sort(key=lambda x: (-x['priority'], x['rule_id']))

    # 按匹配精确度返回最佳匹配
    if exact_matches:
        return exact_matches[0]  # 返回优先级最高的精确匹配
    if regex_matches:
        return regex_matches[0]  # 返回优先级最高的正则匹配
    if wildcard_matches:
        return wildcard_matches[0]  # 返回优先级最高的通配符匹配

    return None  # 没有匹配的规则
```

## 5. 最佳实践建议

### 5.1 规则设计建议

1. **使用有意义的优先级**：
   - 为不同类型的规则分配不同范围的优先级
   - 避免所有规则使用相同的优先级

2. **优先使用精确匹配**：
   - 尽可能使用精确的聊天对象名称，而不是通配符
   - 仅在必要时使用正则表达式和通配符

3. **设置默认规则**：
   - 创建一个低优先级的默认规则，确保所有消息都能被处理
   - 默认规则应使用通配符匹配所有聊天对象

### 5.2 冲突管理建议

1. **定期检查规则冲突**：
   - 使用"检查冲突"功能定期审查规则
   - 解决发现的冲突，确保系统行为符合预期

2. **使用优先级间隔**：
   - 在相关规则之间留出优先级间隔（如10或20）
   - 这样可以在不调整其他规则的情况下插入新规则

3. **记录规则设计意图**：
   - 在规则名称或描述中说明规则的用途和优先级设计意图
   - 这有助于其他用户理解规则系统

