# wxauto_Mgt 模块管理接口分析

本文档分析了wxauto_Mgt项目中四个关键模块的管理接口和方法，为Web管理界面的实现提供基础。

## 1. wxauto管理模块

wxauto管理模块负责管理wxauto实例，包括添加、查看、删除wxauto实例，以及wxauto实例的资源监控。

### 1.1 核心类和方法

#### InstanceManager 类 (wxauto_mgt\core\api_client.py)

```python
class InstanceManager:
    def add_instance(self, instance_id: str, base_url: str, api_key: str, timeout: int = 30) -> WxAutoApiClient
    def get_instance(self, instance_id: str) -> Optional[WxAutoApiClient]
    def remove_instance(self, instance_id: str)
    def get_all_instances(self) -> Dict[str, WxAutoApiClient]
```

#### StatusMonitor 类 (wxauto_mgt\core\status_monitor.py)

```python
class StatusMonitor:
    async def start(self)
    async def stop(self)
    async def get_instance_status(self, instance_id: str) -> Dict
    async def get_instance_metrics(self, instance_id: str) -> Dict
```

### 1.2 数据库表结构

**instances 表**:
- `id`: INTEGER (主键)
- `instance_id`: TEXT (实例唯一标识)
- `name`: TEXT (实例名称)
- `base_url`: TEXT (API基础URL)
- `api_key`: TEXT (API密钥)
- `status`: TEXT (实例状态)
- `enabled`: INTEGER (是否启用)
- `created_at`: INTEGER (创建时间)
- `updated_at`: INTEGER (更新时间)
- `config`: TEXT (实例配置，JSON格式)

### 1.3 主要操作流程

1. **添加实例**:
   - 生成实例ID
   - 创建实例配置
   - 保存到数据库
   - 添加到InstanceManager

2. **查看实例**:
   - 从数据库获取实例列表
   - 获取实例状态和性能指标

3. **删除实例**:
   - 从数据库删除实例
   - 从InstanceManager移除实例

4. **监控实例资源**:
   - 定期获取实例状态
   - 获取CPU、内存等性能指标
   - 更新状态缓存

## 2. 服务平台管理模块

服务平台管理模块负责管理三种类型的服务平台（Dify、OpenAI API、关键词匹配），包括添加、编辑、删除服务平台。

### 2.1 核心类和方法

#### ServicePlatformManager 类 (wxauto_mgt\core\service_platform_manager.py)

```python
class ServicePlatformManager:
    async def initialize(self) -> bool
    async def register_platform(self, platform_type: str, name: str, config: Dict[str, Any]) -> Optional[str]
    async def update_platform(self, platform_id: str, name: str, config: Dict[str, Any]) -> bool
    async def update_platform_simple(self, platform_id: str, name: str, config: Dict[str, Any]) -> bool
    async def delete_platform(self, platform_id: str) -> bool
    async def delete_platform_simple(self, platform_id: str) -> bool
    async def enable_platform(self, platform_id: str, enabled: bool) -> bool
    async def get_platform(self, platform_id: str) -> Optional[ServicePlatform]
    async def get_all_platforms(self) -> List[Dict[str, Any]]
```

#### ServicePlatform 类 (wxauto_mgt\core\service_platform.py)

```python
class ServicePlatform:
    async def initialize(self) -> bool
    async def test_connection(self) -> Dict[str, Any]
    async def process_message(self, message: Dict[str, Any]) -> Dict[str, Any]
```

### 2.2 数据库表结构

**service_platforms 表**:
- `id`: INTEGER (主键)
- `platform_id`: TEXT (平台唯一标识)
- `name`: TEXT (平台名称)
- `type`: TEXT (平台类型：dify/openai/keyword)
- `config`: TEXT (平台配置，JSON格式)
- `enabled`: INTEGER (是否启用)
- `create_time`: INTEGER (创建时间)
- `update_time`: INTEGER (更新时间)

### 2.3 主要操作流程

1. **添加服务平台**:
   - 生成平台ID
   - 创建平台实例
   - 初始化平台
   - 保存到数据库

2. **编辑服务平台**:
   - 获取平台数据
   - 更新平台配置
   - 重新初始化平台
   - 更新数据库

3. **删除服务平台**:
   - 检查是否有规则使用该平台
   - 从数据库删除平台
   - 从管理器移除平台实例

## 3. 消息转发规则模块

消息转发规则模块负责管理消息转发规则，包括添加、修改、删除规则。

### 3.1 核心类和方法

#### RuleManager 类 (wxauto_mgt\core\service_platform_manager.py)

```python
class RuleManager:
    async def initialize(self) -> bool
    async def add_rule(self, name: str, instance_id: str, chat_pattern: str, platform_id: str, priority: int = 0, only_at_messages: int = 0, at_name: str = '', reply_at_sender: int = 0) -> Optional[str]
    async def update_rule(self, rule_id: str, name: str, instance_id: str, chat_pattern: str, platform_id: str, priority: int, only_at_messages: int = 0, at_name: str = '', reply_at_sender: int = 0) -> bool
    async def delete_rule(self, rule_id: str) -> bool
    async def enable_rule(self, rule_id: str, enabled: bool) -> bool
    async def get_rule(self, rule_id: str) -> Optional[Dict[str, Any]]
    async def get_all_rules(self) -> List[Dict[str, Any]]
    async def match_rule(self, instance_id: str, chat_name: str, content: str = "") -> Optional[Dict[str, Any]]
```

### 3.2 数据库表结构

**delivery_rules 表**:
- `id`: INTEGER (主键)
- `rule_id`: TEXT (规则唯一标识)
- `name`: TEXT (规则名称)
- `instance_id`: TEXT (实例ID)
- `chat_pattern`: TEXT (聊天对象匹配模式)
- `platform_id`: TEXT (服务平台ID)
- `priority`: INTEGER (规则优先级)
- `enabled`: INTEGER (是否启用)
- `only_at_messages`: INTEGER (是否只响应@消息)
- `at_name`: TEXT (被@的名称)
- `reply_at_sender`: INTEGER (回复时是否@发送者)
- `create_time`: INTEGER (创建时间)
- `update_time`: INTEGER (更新时间)

### 3.3 主要操作流程

1. **添加规则**:
   - 生成规则ID
   - 保存规则到数据库
   - 重新加载规则

2. **修改规则**:
   - 获取规则数据
   - 更新规则配置
   - 更新数据库
   - 重新加载规则

3. **删除规则**:
   - 从数据库删除规则
   - 重新加载规则

4. **规则匹配**:
   - 根据实例ID和聊天对象匹配规则
   - 检查@消息规则
   - 返回匹配的规则

## 4. 消息监听模块

消息监听模块负责管理消息监听，包括监听对象管理、对象消息管理，消息监听实时日志。

### 4.1 核心类和方法

#### MessageListener 类 (wxauto_mgt\core\message_listener.py)

```python
class MessageListener:
    async def start(self)
    async def stop(self)
    async def pause_listening(self)
    async def resume_listening(self)
    async def has_listener(self, instance_id: str, who: str) -> bool
    async def add_listener(self, instance_id: str, who: str, conversation_id: str = "", **kwargs) -> bool
    async def remove_listener(self, instance_id: str, who: str)
    async def get_listeners(self, instance_id: str = None) -> Dict[str, Dict[str, ListenerInfo]]
    async def get_messages(self, instance_id: str, who: str, limit: int = 20) -> List[Dict[str, Any]]
```

### 4.2 数据库表结构

**listeners 表**:
- `id`: INTEGER (主键)
- `instance_id`: TEXT (实例ID)
- `who`: TEXT (监听对象标识)
- `last_message_time`: INTEGER (最后消息时间)
- `conversation_id`: TEXT (会话ID)
- `create_time`: INTEGER (创建时间)

**messages 表**:
- `id`: INTEGER (主键)
- `instance_id`: TEXT (实例ID)
- `message_id`: TEXT (消息ID)
- `chat_name`: TEXT (聊天对象名称)
- `message_type`: TEXT (消息类型)
- `content`: TEXT (消息内容)
- `sender`: TEXT (发送者)
- `sender_remark`: TEXT (发送者备注)
- `mtype`: TEXT (消息类型)
- `processed`: INTEGER (是否已处理)
- `create_time`: INTEGER (创建时间)

### 4.3 主要操作流程

1. **添加监听对象**:
   - 检查是否超过最大监听数量
   - 调用API添加监听
   - 添加到内存中的监听列表
   - 保存到数据库

2. **移除监听对象**:
   - 调用API移除监听
   - 从内存中移除监听对象
   - 从数据库删除监听对象

3. **获取监听对象消息**:
   - 调用API获取消息
   - 过滤消息
   - 保存消息到数据库
   - 更新监听对象时间戳

4. **监听对象超时处理**:
   - 检查监听对象最后消息时间
   - 超过超时时间自动移除监听对象
