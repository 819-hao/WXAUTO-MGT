# wxauto_Mgt Web管理界面UI规划

本文档规划了wxauto_Mgt项目的Web管理界面，包括整体布局、各模块页面设计和交互流程。

## 1. 整体布局

Web管理界面采用简洁的响应式设计，主要分为以下几个部分：

1. **顶部导航栏**：显示系统名称、操作按钮、当前用户信息和退出按钮
2. **左侧菜单栏**：包含精简的功能模块导航链接
3. **主内容区**：显示当前选中模块的内容
4. **底部状态栏**：显示系统状态、版本信息等

### 1.1 左侧菜单结构（精简版）

- **仪表盘**：系统概览
- **wxauto实例管理**：实例列表和监控
- **服务平台与规则**：服务平台和消息转发规则管理
- **消息监听管理**：监听对象和消息记录
- **系统设置**：基本设置和用户管理

## 2. 各模块页面设计

### 2.1 仪表盘

仪表盘页面提供系统整体状态的可视化展示，包括：

- **系统状态卡片**：显示系统运行状态、启动时间等
- **实例状态概览**：显示所有实例的状态统计（在线/离线/错误）
- **消息处理统计**：显示消息处理数量、成功率等
- **资源使用情况**：显示系统资源使用情况（CPU、内存等）
- **最近活动日志**：显示最近的系统活动日志

### 2.2 wxauto实例管理

wxauto实例管理页面采用卡片式布局，在同一页面上展示实例列表和详细信息，包括以下功能：

- **顶部操作区**：
  - **刷新按钮**：刷新实例列表和状态
  - **添加实例按钮**：打开添加实例对话框
  - **自动刷新开关**：控制是否自动刷新数据
  - **刷新间隔选择器**：设置自动刷新间隔

- **实例卡片列表**：
  - 左侧显示实例卡片，每个卡片包含：
    - 实例名称
    - 实例ID
    - 编辑和删除按钮
  - 点击卡片选中对应实例，右侧显示详细信息

- **实例详细信息区**：
  - **状态指标**：显示消息数量、监听对象数、运行时间、CPU和内存使用率等
  - **操作按钮**：提供启动、停止等操作
  - **监控图表**：显示资源使用趋势

- **添加/编辑实例对话框**：
  - **实例名称**：文本输入框
  - **API基础URL**：文本输入框
  - **API密钥**：密码输入框
  - **超时设置**：数字输入框
  - **备注**：多行文本输入框
  - **启用状态**：开关

### 2.3 服务平台与规则管理

服务平台与规则管理页面将服务平台管理和消息转发规则整合到一个页面，采用类似现有UI的布局，包括以下功能：

#### 2.3.1 页面布局

- **顶部操作区**：
  - **刷新按钮**：刷新平台和规则列表
  - **显示实例选择器**：选择要显示的实例

- **左侧实例卡片**：
  - 显示当前选中的实例信息
  - 包含实例名称、ID、状态指标
  - 提供编辑和删除按钮

- **中间内容区**：分为上下两部分
  - **上部：服务平台配置**
    - **添加平台按钮**：打开添加平台对话框
    - **刷新按钮**：刷新平台列表
    - **平台表格**：显示平台ID、名称、类型、状态等信息
    - **操作按钮**：每行提供编辑、删除、测试等操作按钮

  - **下部：消息转发规则配置**
    - **添加规则按钮**：打开添加规则对话框
    - **刷新按钮**：刷新规则列表
    - **显示全部规则按钮**：显示所有实例的规则
    - **规则表格**：显示规则ID、名称、实例、聊天对象、平台、优先级等信息
    - **操作按钮**：每行提供编辑、删除等操作按钮

#### 2.3.2 添加/编辑平台对话框

添加/编辑平台对话框提供表单，根据平台类型动态显示不同的配置字段：

**通用字段**：
- **平台名称**：文本输入框
- **平台类型**：下拉选择框（Dify、OpenAI API、关键词匹配）
- **启用状态**：开关
- **消息发送模式**：单选按钮（立即发送/分段发送）

**Dify平台特有字段**：
- **API基础URL**：文本输入框
- **API密钥**：密码输入框
- **会话ID**：文本输入框
- **用户ID**：文本输入框

**OpenAI API平台特有字段**：
- **API基础URL**：文本输入框
- **API密钥**：密码输入框
- **模型**：文本输入框
- **温度**：滑动条
- **系统提示**：多行文本输入框
- **最大令牌数**：数字输入框

**关键词匹配平台特有字段**：
- **最小回复时间**：数字输入框
- **最大回复时间**：数字输入框
- **关键词规则列表**：动态表单，支持添加多条规则
  - **关键词**：文本输入框
  - **回复内容**：多行文本输入框
  - **匹配方式**：下拉选择框（精确匹配/包含匹配/模糊匹配）

#### 2.3.3 添加/编辑规则对话框

添加/编辑规则对话框提供表单，包含以下字段：

- **规则名称**：文本输入框
- **实例**：下拉选择框
- **聊天对象匹配模式**：文本输入框
- **服务平台**：下拉选择框
- **规则优先级**：数字输入框
- **只响应@消息**：开关
- **@名称**：文本输入框（支持多个名称，逗号分隔）
- **回复时@发送者**：开关
- **启用状态**：开关

#### 2.3.4 平台测试功能

平台测试功能通过操作按钮触发，包括：

- **测试连接**：测试平台连接是否正常
- **测试消息处理**：输入测试消息，查看平台处理结果
- **测试结果展示**：显示测试结果和响应时间

### 2.4 消息监听管理

消息监听管理页面整合了监听对象列表和消息记录功能，采用分区布局，包括以下功能：

#### 2.4.1 页面布局

- **顶部操作区**：
  - **刷新按钮**：刷新监听对象列表
  - **实例选择器**：选择要显示的实例
  - **自动刷新开关**：控制是否自动刷新数据

- **左侧监听对象列表**：
  - **监听对象表格**：显示实例、监听对象、最后消息时间、超时倒计时等信息
  - **操作按钮**：每行提供查看消息、移除等操作按钮
  - **搜索框**：支持按监听对象名称搜索

- **右侧消息记录区**：
  - **消息过滤器**：支持按时间范围、发送者等筛选消息
  - **消息时间线**：显示消息内容、发送时间、发送者等信息
  - **消息详情**：点击消息可查看详细信息
  - **消息状态**：显示消息处理状态（未处理/处理中/已处理）
  - **重试按钮**：对于处理失败的消息，提供重试功能

- **底部日志区**：
  - **日志级别过滤器**：支持按日志级别（INFO/WARNING/ERROR）筛选日志
  - **关键词搜索**：支持按关键词搜索日志
  - **自动滚动开关**：控制是否自动滚动到最新日志
  - **日志内容**：显示消息监听服务的日志

### 2.5 系统设置

系统设置页面提供基本的系统配置选项，包括以下功能：

#### 2.5.1 页面布局

- **基本设置区**：
  - **监听服务设置**：
    - **轮询间隔**：设置消息监听轮询间隔（秒）
    - **超时时间**：设置监听对象超时时间（分钟）
    - **最大监听数**：设置每个实例的最大监听对象数量

  - **Web服务设置**：
    - **端口**：设置Web服务端口
    - **主机**：设置Web服务主机地址
    - **启用HTTPS**：控制是否启用HTTPS
    - **证书设置**：配置SSL证书（如果启用HTTPS）

  - **日志设置**：
    - **日志级别**：设置日志记录级别
    - **日志保留天数**：设置日志文件保留天数

- **用户管理区**（如果需要）：
  - **用户列表**：显示系统用户
  - **添加用户按钮**：添加新用户
  - **用户权限设置**：设置用户权限

## 3. 交互流程

### 3.1 添加wxauto实例流程

1. 用户在实例管理页面点击"添加实例"按钮
2. 系统显示添加实例对话框
3. 用户填写实例信息并提交
4. 系统验证表单数据并创建实例
5. 系统刷新实例列表，显示新添加的实例

### 3.2 添加服务平台流程

1. 用户在服务平台与规则管理页面点击"添加平台"按钮
2. 系统显示添加平台对话框
3. 用户选择平台类型，系统动态加载相应的配置字段
4. 用户填写平台信息并提交
5. 系统验证表单数据并创建平台
6. 系统刷新平台列表，显示新添加的平台

### 3.3 添加消息转发规则流程

1. 用户在服务平台与规则管理页面点击"添加规则"按钮
2. 系统显示添加规则对话框
3. 用户填写规则信息并提交
4. 系统验证表单数据并创建规则
5. 系统刷新规则列表，显示新添加的规则

### 3.4 查看监听对象消息流程

1. 用户在监听对象列表中选择一个监听对象
2. 系统在右侧消息记录区加载该监听对象的消息
3. 用户可以查看消息内容和处理状态
4. 用户可以对处理失败的消息进行重试

## 4. 技术实现方案

### 4.1 前端技术栈

- **框架**：Vue.js 3 + Vite
- **UI组件库**：Element Plus
- **状态管理**：Pinia
- **路由**：Vue Router
- **HTTP客户端**：Axios
- **图表库**：ECharts
- **WebSocket**：用于实时日志和消息推送

### 4.2 后端技术栈

- **Web框架**：FastAPI
- **认证**：JWT (JSON Web Tokens)
- **数据库访问**：使用现有SQLite数据库和接口，不修改现有数据库架构
- **WebSocket**：FastAPI WebSockets
- **任务队列**：BackgroundTasks

### 4.3 API设计

#### 4.3.1 认证API

- `POST /api/auth/login` - 用户登录
- `POST /api/auth/logout` - 用户登出
- `GET /api/auth/me` - 获取当前用户信息
- `PUT /api/auth/password` - 修改密码

#### 4.3.2 实例管理API

- `GET /api/instances` - 获取所有实例
- `GET /api/instances/{instance_id}` - 获取特定实例
- `POST /api/instances` - 创建新实例
- `PUT /api/instances/{instance_id}` - 更新实例
- `DELETE /api/instances/{instance_id}` - 删除实例
- `GET /api/instances/{instance_id}/status` - 获取实例状态
- `GET /api/instances/{instance_id}/metrics` - 获取实例性能指标

#### 4.3.3 服务平台API

- `GET /api/platforms` - 获取所有服务平台
- `GET /api/platforms/{platform_id}` - 获取特定服务平台
- `POST /api/platforms` - 创建新服务平台
- `PUT /api/platforms/{platform_id}` - 更新服务平台
- `DELETE /api/platforms/{platform_id}` - 删除服务平台
- `POST /api/platforms/{platform_id}/test` - 测试服务平台连接

#### 4.3.4 转发规则API

- `GET /api/rules` - 获取所有规则
- `GET /api/rules/{rule_id}` - 获取特定规则
- `POST /api/rules` - 创建新规则
- `PUT /api/rules/{rule_id}` - 更新规则
- `DELETE /api/rules/{rule_id}` - 删除规则
- `PATCH /api/rules/{rule_id}/priority` - 更新规则优先级

#### 4.3.5 消息监听API

- `GET /api/listeners` - 获取所有监听对象
- `GET /api/listeners/{instance_id}/{who}` - 获取特定监听对象
- `POST /api/listeners` - 添加监听对象
- `DELETE /api/listeners/{instance_id}/{who}` - 移除监听对象
- `GET /api/messages` - 获取消息列表
- `GET /api/messages/{message_id}` - 获取特定消息
- `POST /api/messages/{message_id}/retry` - 重试消息处理

#### 4.3.6 系统API

- `GET /api/system/status` - 获取系统状态
- `GET /api/system/logs` - 获取系统日志
- `POST /api/system/reload` - 重载系统配置
- `GET /api/system/metrics` - 获取系统性能指标

### 4.4 WebSocket接口

- `/ws/logs` - 实时日志流
- `/ws/messages` - 实时消息推送
- `/ws/status` - 实时状态更新

## 5. 安全性设计

### 5.1 认证与授权

- 使用JWT进行用户认证
- 基于角色的访问控制（RBAC）
- API密钥保护敏感接口
- 会话超时自动登出

### 5.2 数据安全

- 敏感信息（如API密钥）加密存储
- HTTPS传输加密
- 输入验证和防XSS攻击
- CSRF防护

### 5.3 日志与审计

- 用户操作日志记录
- 安全事件审计
- 登录尝试记录
- 敏感操作二次确认

## 6. 部署方案

### 6.1 开发环境

- 前端开发服务器：`npm run dev`
- 后端开发服务器：`uvicorn main:app --reload`
- 数据库：SQLite开发数据库

### 6.2 生产环境

- 前端构建：`npm run build`
- 后端服务器：Uvicorn + Gunicorn
- 反向代理：Nginx
- 静态资源缓存
- 数据库备份策略

### 6.3 容器化部署（可选）

- Docker容器化
- Docker Compose编排
- 环境变量配置
- 数据卷持久化

## 7. 后续扩展计划

### 7.1 功能扩展

- 消息统计分析
- 自定义报表生成
- 批量操作工具
- 定时任务管理
- 多语言支持

### 7.2 性能优化

- 数据库查询优化
- 前端资源懒加载
- API响应缓存
- WebSocket连接池
- 大数据量分页处理

### 7.3 集成扩展

- 更多服务平台类型支持
- 第三方监控系统集成
- 移动端适配
- 消息模板管理
- 自动化测试工具
